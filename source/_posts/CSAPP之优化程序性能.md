---
title: CSAPP之优化程序性能
tags:
  - CSAPP
toc: true
date: 2017-11-03 10:31:39
---
# 前言
程序性能优化最重要的原则是在`保证程序正确性`的基础上，使用多种手段，反复尝试分析，有时甚至需要查看底层对应的汇编代码，从而找出性能的瓶颈，进行合理的优化。另外，我们需要注意的是在性能重要的环境中反复执行的代码，进行优化是合适的。为了提升程序的性能，我们做了大量的修改优化，但仍然要保持代码的简洁和可读性。如果我们盲目执行对低级别的优化，往往会降低程序的可读性，使得程序难以扩展和维护。因此，我们需要在`程序实现和维护的简单性与它们的运行速度`之间做出权衡。在性能优化过程中，我们经常遇到`很小的改动但产生性能巨大的差异，有时一些很有希望的技术却被证明无效`的场景，这是因为性能依赖于处理器许多特性的设计，而我们却所知甚少，因此，性能的优化往往是比较困难的，需要我们有足够的经验，采用各种综合手段去分析，挖掘性能的瓶颈。

# 优化方法
## 熟悉编译器优化选项
在大多数情况下，我们都是使用高级的程序语言，需要通过编译器将源码转变成机器识别执行的机器程序。因此，我们需要对使用的编译器的优化选项有大致的了解，其中[gcc optimize options](https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html)编译优化选项在其使用手册文档中有详细说明。因为编译器优化能力的局限性和安全性，导致很多情形下编译器很无法执行理想的优化，因此，需要程序员编写编译器容易优化的代码，帮助编译器显式执行优化。
## 消除循环低效率
在循环过程中，重复计算没有改变的量应该使用局部变量进行保存，减少不必要的重复计算。例如，CSAPP作者举例的`将字符串由小写转成成大小`的示例中，在每次循环中求取保持不变的字符串长度量，导致函数的运行时间为二次方。如果使用局部变量保存长度，函数的时间开销为线性。作者特别提到，编程中更常见的问题是`一个无足轻重的代码隐藏着渐进的低效率`，使得当问题的规模较小时，根本无法发现问题。因此我们作为一名有经验合格的程序员应该竭力避免引入这种`渐进低效率`的问题。
<!--more-->
## 减少过程调用
过程调用会带来开销，并且妨碍程序的优化。
## 消除不必要的内存引用
对于指针变量来说，每次对指针变量的引用都会涉及内存的访问，相对寄存器访问速度来说，内存读写是低效的，因此，如果过多的内存医用会降低程序的效率。我们可以将中间的计算过程保存在局部变量中，利用寄存器访问的高效性提高程序的性能。
## 理解现代处理器
一致性：多条指令可以并行执行，但与多条指令简单顺序执行效果一致<br>
乱序性：指令的执行顺序并不与机器程序的指令顺序一致
