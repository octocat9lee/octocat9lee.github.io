---
title: CSAPP之虚拟内存
tags:
  - CSAPP
toc: true
date: 2017-11-28 15:33:47
---
# 前言
本文介绍虚拟内存如何工作以及应用程序如何使用和管理虚拟内存。虚拟内存由硬件异常、硬件地址翻译、主存、磁盘文件和内核交互，为每个进程提供一个大的、一致的和私有的地址空间，提供如下三个重要功能：
>1) 作为主存和磁盘的高速缓存，在主存中只保存活动区域
2) 为每个进程提供了一致的地址空间，从而简化内存管理
3) 保护每个进程的地址空间不被其他进程破坏

# 虚拟内存作为缓存的工具
磁盘和主存间的传输单元为虚拟页(Virtual Page, VP)。虚拟页和物理页(页帧)为相同的固定大小的块。虚拟存储在磁盘上，物理页存储在主存中。在任意时刻，虚拟页集合分为三个不相交的子集：未分配的，缓存的和未缓存的。
术语SRAM缓存表示CPU和主存之间的L1、L2和L3高速缓存，DRAM缓存表示虚拟内存系统的缓存，在主存中缓存虚拟页。因为大的不命中处罚和访问磁盘第一个字节的开销，所以`虚拟页往往很大`，通常在4KB~2MB。由于大的不命中处罚，`DRAM缓存是全相联`，即任何虚拟页都可以放置在任何的物理页中。最后，因为对磁盘的访问时间长，DRAM缓存总是使用`写回`，而不是直写。
<!--more-->
## 页表
页表就是一个页表条目(Page Table Entry,PTE)的数组。虚拟地址空间中的每个页在页表中一个固定的偏移量处都有一个PTE。每个PTE项包括一个有效位和一个n位地址字段。有效位表明该虚拟页当前是否被缓存在DRAM中，如果设置了有效位，那么地址字段就表示DRAM中相应的物理页的起始位置，这个物理页中缓存了该虚拟页。如果没有设置有效位，那么一个空地址表示这个虚拟页还未分配。否则，这个地址就指向该虚拟页在磁盘上的起始位置。为了控制内存系统的访问，PTE表项中添加一些额外的许可位来控制对一个虚拟页面内容的访问。如果指令违反了许可条件，那么CPU就触发一个一般保护故障，将控制传递给一个内核中的异常处理程序。Linux shell一般将这种异常报告为"段错误(segmentaion fault)"。

## 局部性
虚拟内存系统能够工作良好，是由于局部性，局部性保证程序在一个较小的活动页面集合上工作，这个集合叫做工作集或者常驻集合。只要我们的程序有好的时间局部性，虚拟内存系统就能工作良好。如果程序性能低下，考虑是否发生了抖动，即页面不断的换进换出。可以使用Linux的`getrusage`函数检测缺页的数量以及其他信息。
